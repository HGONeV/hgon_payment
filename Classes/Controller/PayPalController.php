<?phpnamespace HGON\HgonPayment\Controller;/*** * * This file is part of the "HGON Donation" Extension for TYPO3 CMS. * * For the full copyright and license information, please read the * LICENSE.txt file that was distributed with this source code. * *  (c) 2018 Maximilian Fäßler <maximilian@faesslerweb.de>, Fäßler Web UG * ***/use HGON\HgonPayment\Session\BasketSessionService;use TYPO3\CMS\Core\Utility\GeneralUtility;/** * PayPalController */class PayPalController extends \TYPO3\CMS\Extbase\Mvc\Controller\ActionController{    /**     * @var \TYPO3\CMS\Beuser\Domain\Repository\BackendUserRepository     */    protected $backendUserRepository;    /**     * @param \TYPO3\CMS\Beuser\Domain\Repository\BackendUserRepository $backendUserRepository     */    public function injectBackendUserRepository(\TYPO3\CMS\Beuser\Domain\Repository\BackendUserRepository $backendUserRepository): void {        $this->backendUserRepository = $backendUserRepository;    }    public function __construct(        private readonly BasketSessionService $basketSessionService    ) {        parent::__construct();    }    public function addToBasketAction(): void    {        $basket = $this->basketSessionService->getBasket();        // ... basket anpassen ...        // $this->basketSessionService->setBasket($basket);    }    public function clearBasketAction(): void    {        $this->basketSessionService->clearBasket();    }    /**     * action confirmPaymentAction     * coming back from paypal with payment authorization     *     * @return void     */    public function confirmPaymentAction()    {        if (            GeneralUtility::_GP('paymentId')            && GeneralUtility::_GP('token')            && GeneralUtility::_GP('PayerID')            && $this->session->getBasket()        ) {            /** @var \HGON\HgonPayment\Domain\Model\Basket $basket */            //$basket = $this->session->get('hgon_payment_basket');            $basket = $this->session->getBasket();            $basket->setPaymentData([                'paymentId' => preg_replace('/[^A-Z0-9-]/', '', GeneralUtility::_GP('paymentId')),                'token'     => preg_replace('/[^A-Z0-9-]/', '', GeneralUtility::_GP('token')),                'payerId'   => preg_replace('/[^A-Z0-9-]/', '', GeneralUtility::_GP('PayerID'))            ]);            //$this->session->set('hgon_payment_basket', $basket);            $this->session->setBasket($basket);            $this->forward('executePayment');            // diese Zwischenseite müsste nur genutzt werden, wenn sie zur finalen Bestellbestätigung dient            //    $this->view->assign('basket', $basket);        }        // if this data set - but we do not have some data in session - show error in view        if (            GeneralUtility::_GP('paymentId')            && GeneralUtility::_GP('token')            && GeneralUtility::_GP('PayerID')        ) {            $this->view->assign('showMessage', true);        }    }    /**     * action executePaymentAction     * action for executing donation money (PayPal)     *     * @return void     */    public function executePaymentAction()    {        /** @var \HGON\HgonPayment\Domain\Model\Basket $basket */        //$basket = $this->session->get('hgon_payment_basket');        $basket = $this->session->getBasket();        $paymentDataArray = $basket->getPaymentData();        /** @var \HGON\HgonPayment\Api\PayPalApi $payPalApi */        $payPalApi = $this->objectManager->get(\HGON\HgonPayment\Api\PayPalApi::class);        $result = $payPalApi->executePayment($paymentDataArray['paymentId'], $paymentDataArray['token'], $paymentDataArray['payerId']);        // $this->view->assign('basket', $basket);        //    DebuggerUtility::var_dump($basket);        //    DebuggerUtility::var_dump($result); exit;        // @toDo: Save Order        // Mailing        if ($result->state == "approved") {            $this->sendMails($result, $basket);        }        // the redirect removes the payment data from url        $this->redirect('finishedPayment', 'PayPal', 'HgonPayment', ['result' => $result->state]);    }    /**     * action finishedPaymentAction     * action for finishing donation money (PayPal)     *     * @param string $result     * @return void     */    public function finishedPaymentAction($result)    {        if ($result  == "approved") {            $this->view->assign('basket', $this->session->getBasket());        }        // remove Session data        $this->session->clearBasket();    }    /**     * action confirmSubscriptionAction     * coming back from paypal with payment authorization     *     * @return void     */    public function confirmSubscriptionAction()    {        // ?subscription_id=I-YXJ3MBF0C4UJ&ba_token=BA-3CT986595A364260E&token=0Y278938SV1387338        // @toDo: Does we need an additional subscription execution, like on one time payments? Obviously not!        // -> We can reactivate, update, cancel subscription etc.        if (            GeneralUtility::_GP('subscription_id')            && GeneralUtility::_GP('token')            && GeneralUtility::_GP('ba_token')            && $this->session->getBasket()        ) {            /** @var \HGON\HgonPayment\Domain\Model\Basket $basket */            $basket = $this->session->getBasket();            $basket->setPaymentData([                'subscriptionId' =>  preg_replace('/[^A-Z0-9-]/', '', GeneralUtility::_GP('subscription_id')),                'token' =>  preg_replace('/[^A-Z0-9-]/', '', GeneralUtility::_GP('token')),                'baToken' =>  preg_replace('/[^A-Z0-9-]/', '', GeneralUtility::_GP('ba_token'))            ]);            /** @var \HGON\HgonPayment\Api\PayPalApi $payPalApi */            $payPalApi = $this->objectManager->get(\HGON\HgonPayment\Api\PayPalApi::class);            $result = $payPalApi->getSubscription(GeneralUtility::_GP('subscription_id'));            $this->session->setBasket($basket);            //  obviously not necessary (subscription is already activated)            //  $this->forward('executeSubscription');            $this->sendMails($result, $basket);        //    $this->view->assign('basket', $basket);            // the redirect removes the payment data from url            $this->redirect('finishedSubscription');        }        // if this data set - but we do not have some data in session - show error in view        if (            GeneralUtility::_GP('subscription_id')            && GeneralUtility::_GP('token')            && GeneralUtility::_GP('ba_token')        ) {            $this->view->assign('showMessage', true);        }    }    /**     * action executeSubscriptionAction     * action for executing subscriptions (PayPal)     *     * @return void     */    public function executeSubscriptionAction()    {    }    /**     * action finishedSubscriptionAction     * action for finishing donation money (PayPal)     *     * @return void     */    public function finishedSubscriptionAction()    {        $this->view->assign('basket', $this->session->getBasket());        // remove Session data        $this->session->clearBasket();    }    /**     *     * @param mixed $result     * @param mixed $basket     */    private function sendMails($result, $basket) {        /** @var \TYPO3\CMS\Extbase\Object\ObjectManager $objectManager */        $objectManager = GeneralUtility::makeInstance(\TYPO3\CMS\Extbase\Object\ObjectManager::class);       /*        $frontendUser = $objectManager->get(\RKW\RkwRegistration\Domain\Model\FrontendUser::class);        if ($result->subscriber instanceof \stdClass) {            // subscription            $frontendUser->setEmail($result->subscriber->email_address);            $frontendUser->setFirstName($result->subscriber->name->given_name);            $frontendUser->setLastName($result->subscriber->name->surname);        } elseif ($result->payer instanceof \stdClass) {            // payment            $frontendUser->setEmail($result->payer->payer_info->email);            $frontendUser->setFirstName($result->payer->payer_info->first_name);            $frontendUser->setLastName($result->payer->payer_info->last_name);        }        $frontendUser->setTxRkwregistrationLanguageKey('de');        */        // @toDo: use just for testing        // $frontendUser->setEmail('maximilian@faesslerweb.de');        /** @var \HGON\HgonPayment\Helper\DataConverter $dataConverter */        $dataConverter = $objectManager->get(\HGON\HgonPayment\Helper\DataConverter::class);        $paymentData = [];        if ($result->subscriber instanceof \stdClass) {            // is subscription            $paymentData = $dataConverter->subscriptionPayPal($result, $basket);        } elseif ($result->payer instanceof \stdClass) {            // is payment            $paymentData = $dataConverter->paymentPayPal($result, $basket);        }        /** @var \HGON\HgonPayment\Service\RkwMailService $rkwMailService */        $rkwMailService = $objectManager->get(\HGON\HgonPayment\Service\RkwMailService::class);        $rkwMailService->confirmPayPalUser($frontendUser, $paymentData);        // workaround to avoid repo is null.        /** @var \TYPO3\CMS\Beuser\Domain\RepositoryBackendUserRepository $backendUserRepository */        $backendUserRepository = $objectManager->get(\TYPO3\CMS\Beuser\Domain\Repository\BackendUserRepository::class);        if (intval($this->settings['backendUserContactPerson'])) {            $backendUser = $backendUserRepository->findByIdentifier(intval($this->settings['backendUserContactPerson']));            if ($backendUser instanceof \TYPO3\CMS\Beuser\Domain\Model\BackendUser) {                $rkwMailService->confirmPayPalAdmin($backendUser, $paymentData, $frontendUser);            }        }    }}